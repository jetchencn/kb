请分场景构建详细时序图

以下是针对综合收费管理四大核心场景的详细时序图设计，涵盖收费支付、发票管理、收据管理、退费管理的完整交互流程：

---

### 场景1：收费支付（含自动开票）
```mermaid
sequenceDiagram
    actor User as 用户(服务号)
    participant CM as 收费管理应用
    participant PP as 支付平台
    participant DAP as DAP财务平台
    participant Bank as 银行系统
    
    User->>+CM: 1. 提交缴费申请
    CM->>CM: 2. 生成收费单(SN20240808001)
    CM-->>User: 3. 返回支付二维码
    User->>+PP: 4. 扫码支付(微信)
    PP-->>-CM: 5. 支付回调通知(成功)
    CM->>CM: 6. 更新状态为已支付
    CM->>CM: 7. 生成缴费台账
    
    alt 满足自动开票规则
        CM->>+DAP: 8. 自动推送开票申请
        DAP->>DAP: 9. 调用税务UKey开票
        DAP-->>-CM: 10. 返回发票影像URL
        CM->>User: 11. 推送开票完成通知
    end
    
    CM->>DAP: 12. 推送缴费记录
    DAP->>+Bank: 13. 获取交易流水
    Bank-->>-DAP: 14. 返回流水记录
    DAP->>DAP: 15. 对账匹配(容差±0.1元)
    alt 对账一致
        DAP->>DAP: 16. 生成收款凭证(P20240808001)
        DAP-->>CM: 17. 同步凭证号
    else 存在差异
        DAP->>DAP: 16. 创建差异工单
        DAP-->>CM: 17. 触发财务告警
    end
    CM->>CM: 18. 更新台账状态
```

---

### 场景2：发票管理（手动申请+红冲）
```mermaid
sequenceDiagram
    actor User as 用户(PC端)
    participant CM as 收费管理应用
    participant DAP as DAP财务平台
    participant Tax as 税务系统
    
    User->>+CM: 1. 查询缴费记录(SN20240808002)
    CM-->>-User: 2. 返回待开票订单
    User->>+CM: 3. 发起发票申请(选择企业抬头)
    CM->>+DAP: 4. 推送开票申请
    DAP->>+Tax: 5. 获取税收分类编码
    Tax-->>-DAP: 6. 返回编码信息
    DAP->>DAP: 7. 校验商品名称合规性
    DAP->>+Tax: 8. 蓝字发票开具
    Tax-->>-DAP: 9. 返回发票号码+影像
    DAP-->>-CM: 10. 同步开票状态
    CM->>User: 11. 通知发票可下载
    
    loop 后续发生退款
        User->>+CM: 12. 提交退费申请
        CM->>+DAP: 13. 推送退费指令
        DAP->>+Tax: 14. 红字发票开具
        Tax-->>-DAP: 15. 返回红冲结果
        DAP-->>-CM: 16. 更新发票状态(已红冲)
        CM->>User: 17. 通知发票失效
    end
```

---

### 场景3：收据管理（申请+核销）
```mermaid
sequenceDiagram
    actor User as 用户(服务号)
    participant CM as 收费管理应用
    participant DAP as DAP财务平台
    participant Finance as 财务系统
    
    User->>+CM: 1. 发起收据申请(选择模板T3)
    CM->>+DAP: 2. 推送收据申请
    DAP->>DAP: 3. 加载电子章(SZ2024)
    DAP->>DAP: 4. 生成收据影像(PDF)
    DAP-->>-CM: 5. 返回收据URL+状态
    CM->>User: 6. 推送收据下载链接
    
    alt 线下核销场景
        Finance->>+DAP: 7. 发起收据核销(核销单号)
        DAP->>DAP: 8. 更新收据状态(已核销)
        DAP-->>-CM: 9. 同步核销状态
        CM->>DAP: 10. 请求关联收款凭证
        DAP-->>CM: 11. 返回凭证信息
    end
```

---

### 场景4：退费管理（原路退回失败转银行卡）
```mermaid
sequenceDiagram
    actor User as 用户(服务号)
    participant CM as 收费管理应用
    participant DAP as DAP财务平台
    participant PP as 支付平台
    participant Bank as 银行系统
    
    User->>+CM: 1. 提交退费申请
    CM->>CM: 2. 校验原订单有效性
    CM->>+DAP: 3. 推送退费申请
    
    alt 原路退回
        DAP->>+PP: 4. 发起微信原路退款
        PP-->>-DAP: 5. 返回失败(账户异常)
        DAP-->>-CM: 6. 通知退费失败
        CM->>User: 7. 请求确认新银行卡
        User->>CM: 8. 提交银行卡信息
        CM->>+DAP: 9. 重推退费申请(银行卡)
        DAP->>+Bank: 10. 银企直联退款
        Bank-->>-DAP: 11. 返回成功
    else 直接银行卡退款
        DAP->>+Bank: 4. 银企直联退款
        Bank-->>-DAP: 5. 返回成功
    end
    
    DAP->>DAP: 12. 自动作废关联收据
    DAP->>DAP: 13. 红冲关联发票
    DAP-->>CM: 14. 同步退费结果+票据状态
    CM->>User: 15. 通知退费完成
    DAP->>DAP: 16. 记录退费台账
```

---

### 关键设计说明：
1. **支付中断补偿机制**  
   - 场景1步骤5：支付平台回调失败时，收费系统主动轮询支付状态
   - 设置超时阈值（如30秒），触发自动补偿查询

2. **双通道退费设计**  
   - 场景4展示两种路径：
     - 优先原路退回（步骤4-8）
     - 失败后切换银行卡退款（步骤9-11）
   - 本地资金池垫付能力（虚线补充流程）

3. **财务合规控制点**  
   - 发票红冲前强制审批（场景2步骤14）
   - 大额退费（>5万）增加财务复核节点

4. **状态同步保障**  
   - 所有关键操作（开票/退费/核销）均实现：
     ``` 
     DAP → 收费系统：状态回传
     收费系统 → 用户端：状态通知
     ```

5. **自动化处理优化**  
   - 自动开票规则引擎（场景1步骤8）
   - 对账容差自动调账（场景1步骤15）

---

### 时序图优化亮点：
1. **异常分支显式标注**  
   - 使用`alt/else`清晰展示正常流与异常流
   - 如退费失败转银行卡、对账差异处理

2. **关键属性传递**  
   - 标注核心业务标识：流水号(SNxxx)、凭证号(Pxxx)
   - 票据状态变更记录（已开/红冲/核销）

3. **财务系统深度集成**  
   - 展示与税务系统、银行系统的深度交互
   - 强调DAP作为财务中枢的定位

4. **用户触点全覆盖**  
   - 区分服务号移动端与PC端操作场景
   - 关键节点均有用户通知机制

此设计完整呈现了收费业务的全链路闭环，既满足高频交易效率要求，又保障财务合规性，通过清晰的异常处理路径增强系统鲁棒性。